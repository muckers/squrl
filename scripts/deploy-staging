#!/bin/bash
#
# Deploy web UI to staging environment
#
# This script uploads the web-ui files to the staging S3 bucket
# and invalidates the CloudFront cache to ensure changes are visible.
#

set -e

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Configuration
S3_BUCKET="${S3_BUCKET:-squrl-web-ui-dev}"
CLOUDFRONT_DISTRIBUTION_ID="${CLOUDFRONT_DISTRIBUTION_ID:-}"  # Set via environment variable
WEB_UI_DIR="${WEB_UI_DIR:-./web-ui}"  # Default to ./web-ui relative to project root

echo -e "${BLUE}üöÄ Deploying web UI to staging environment...${NC}"
echo

# Check if CloudFront distribution ID is set
if [ -z "$CLOUDFRONT_DISTRIBUTION_ID" ]; then
    echo -e "${RED}‚ùå Error: CLOUDFRONT_DISTRIBUTION_ID environment variable is not set${NC}"
    echo "   Please set it to your CloudFront distribution ID"
    echo "   Example: export CLOUDFRONT_DISTRIBUTION_ID=EXXXXXXXXXXXXX"
    exit 1
fi

# Check if web-ui directory exists
if [ ! -d "$WEB_UI_DIR" ]; then
    echo -e "${RED}‚ùå Error: Web UI directory not found: $WEB_UI_DIR${NC}"
    exit 1
fi

# Change to web-ui directory
cd "$WEB_UI_DIR"

# Upload files to S3
echo -e "${YELLOW}üì§ Uploading files to S3 bucket: $S3_BUCKET${NC}"

# Upload HTML files
for file in *.html; do
    if [ -f "$file" ]; then
        echo "  Uploading $file..."
        aws s3 cp "$file" "s3://$S3_BUCKET/$file" --content-type "text/html"
    fi
done

# Upload image files
for ext in jpg jpeg png gif svg; do
    for file in *.$ext; do
        if [ -f "$file" ]; then
            echo "  Uploading $file..."
            case "$ext" in
                jpg|jpeg) content_type="image/jpeg" ;;
                png) content_type="image/png" ;;
                gif) content_type="image/gif" ;;
                svg) content_type="image/svg+xml" ;;
            esac
            aws s3 cp "$file" "s3://$S3_BUCKET/$file" --content-type "$content_type"
        fi
    done
done

# Upload CSS files
for file in *.css; do
    if [ -f "$file" ]; then
        echo "  Uploading $file..."
        aws s3 cp "$file" "s3://$S3_BUCKET/$file" --content-type "text/css"
    fi
done

# Upload JS files
for file in *.js; do
    if [ -f "$file" ]; then
        echo "  Uploading $file..."
        aws s3 cp "$file" "s3://$S3_BUCKET/$file" --content-type "application/javascript"
    fi
done

echo -e "${GREEN}‚úÖ Files uploaded successfully${NC}"
echo

# Invalidate CloudFront cache
echo -e "${YELLOW}üîÑ Invalidating CloudFront cache...${NC}"
INVALIDATION_RESULT=$(aws cloudfront create-invalidation \
    --distribution-id "$CLOUDFRONT_DISTRIBUTION_ID" \
    --paths "/*" \
    --output json)

INVALIDATION_ID=$(echo "$INVALIDATION_RESULT" | jq -r '.Invalidation.Id')

if [ "$INVALIDATION_ID" != "null" ]; then
    echo -e "${GREEN}‚úÖ CloudFront invalidation created: $INVALIDATION_ID${NC}"
    echo "   Cache invalidation is in progress..."
else
    echo -e "${RED}‚ùå Failed to create CloudFront invalidation${NC}"
    exit 1
fi

echo
echo -e "${GREEN}üéâ Deployment completed successfully!${NC}"
echo -e "${BLUE}   Staging URL: https://staging.squrl.pub/${NC}"
echo
echo "Note: It may take a few minutes for the CloudFront cache to fully update."